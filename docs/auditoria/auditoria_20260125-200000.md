# ğŸ“‹ Auditoria TÃ©cnica â€” pyloto_corp

**Data:** 25 de janeiro de 2026 Ã s 20:00  
**Auditor:** Senior Software Engineering Analysis  
**Modo:** Auditoria estruturada de conformidade  
**Fontes de Verdade:** `regras_e_padroes.md` | `Funcionamento.md` | `Monitoramento_Regras-Padroes.md` | `README.md`  

---

## ğŸ“„ Arquivos em Conformidade

Os seguintes **51 arquivos** foram analisados e **NÃƒO apresentam violaÃ§Ãµes significativas**:

**Adapters WhatsApp (13 arquivos):**
- `adapters/whatsapp/__init__.py`
- `adapters/whatsapp/models.py` â€” 128 linhas (OK)
- `adapters/whatsapp/signature.py` â€” ~40 linhas
- `adapters/whatsapp/validators/__init__.py`
- `adapters/whatsapp/validators/errors.py` â€” ~20 linhas
- `adapters/whatsapp/validators/limits.py` â€” ~40 linhas
- `adapters/whatsapp/validators/media.py` â€” ~70 linhas
- `adapters/whatsapp/validators/text.py` â€” ~50 linhas
- `adapters/whatsapp/validators/template.py` â€” 85 linhas
- `adapters/whatsapp/validators/interactive.py` â€” 134 linhas
- `adapters/whatsapp/validators/orchestrator.py` â€” 124 linhas
- `adapters/whatsapp/normalizer.py` â€” 287 linhas (ATENÃ‡ÃƒO â€” vide seÃ§Ã£o abaixo)
- `adapters/whatsapp/outbound.py` â€” 180 linhas (OK)

**Payload Builders (7 arquivos):**
- `adapters/whatsapp/payload_builders/__init__.py`
- `adapters/whatsapp/payload_builders/base.py` â€” ~30 linhas
- `adapters/whatsapp/payload_builders/text.py` â€” ~25 linhas
- `adapters/whatsapp/payload_builders/media.py` â€” 91 linhas
- `adapters/whatsapp/payload_builders/interactive.py` â€” 101 linhas
- `adapters/whatsapp/payload_builders/template.py` â€” ~45 linhas
- `adapters/whatsapp/payload_builders/location.py` â€” ~35 linhas
- `adapters/whatsapp/payload_builders/factory.py` â€” 87 linhas

**API e Config (3 arquivos):**
- `api/__init__.py` â€” ~15 linhas
- `api/app.py` â€” ~50 linhas
- `api/dependencies.py` â€” ~45 linhas
- `config/__init__.py` â€” ~20 linhas
- `config/settings.py` â€” 136 linhas

**Domain (7 arquivos):**
- `domain/__init__.py`
- `domain/audit.py` â€” ~60 linhas
- `domain/conversations.py` â€” ~40 linhas
- `domain/enums.py` â€” 103 linhas
- `domain/intent_queue.py` â€” ~40 linhas
- `domain/models.py` â€” ~50 linhas
- `domain/profile.py` â€” 124 linhas (OK)
- `domain/secret_provider.py` â€” ~25 linhas (nova, refatoraÃ§Ã£o)
- `domain/outbound_dedup.py` â€” 104 linhas (nova, refatoraÃ§Ã£o)

**Application (6 arquivos):**
- `application/__init__.py`
- `application/audit.py` â€” 72 linhas
- `application/conversations.py` â€” 176 linhas
- `application/handoff.py` â€” ~30 linhas
- `application/session.py` â€” ~25 linhas
- `application/export.py` â€” 177 linhas (refatorado â€” OK)
- `application/services/dedup_service.py` â€” 60 linhas (nova, refatoraÃ§Ã£o)
- `application/renderers/export_renderers.py` â€” 153 linhas (nova, refatoraÃ§Ã£o)

**Infra (8 arquivos â€” refatorados):**
- `infra/__init__.py` â€” ~80 linhas
- `infra/secret_provider.py` â€” ~20 linhas (nova, refatoraÃ§Ã£o)
- `infra/outbound_dedup_memory.py` â€” 87 linhas (nova, refatoraÃ§Ã£o)
- `infra/outbound_dedup_redis.py` â€” 129 linhas (nova, refatoraÃ§Ã£o)
- `infra/outbound_dedup_firestore.py` â€” 161 linhas (nova, refatoraÃ§Ã£o)
- `infra/outbound_dedup_factory.py` â€” ~58 linhas (nova, refatoraÃ§Ã£o)
- `infra/firestore_conversations.py` â€” 126 linhas
- `infra/firestore_audit.py` â€” 196 linhas (ALERTA â€” vide seÃ§Ã£o abaixo)

**Observability e Utils (3 arquivos):**
- `observability/__init__.py`
- `observability/logging.py` â€” ~45 linhas
- `observability/middleware.py` â€” ~40 linhas
- `observability/metrics.py` â€” ~20 linhas
- `utils/__init__.py` â€” ~10 linhas
- `utils/ids.py` â€” ~20 linhas

**Root:**
- `__init__.py` â€” ~5 linhas

**Total em conformidade:** 51 arquivos âœ…

---

## âš ï¸ Arquivos com ATENÃ‡ÃƒO

### 1. infra/outbound_dedupe.py

**Tamanho:** 495 linhas  
**Regra violada:** SeÃ§Ã£o 2.1 â€” Tamanho mÃ¡ximo 200 linhas (intervalo 401â€“500 = ALERTA elevado)  
**EvidÃªncia:**
- Arquivo contÃ©m: Protocol + DTOs + 3 implementaÃ§Ãµes (Memory/Redis/Firestore) + 2 funÃ§Ãµes helper + factory
- Linhas contabilizadas: 495 (confirmado via `wc -l`)
- Estrutura interna: mÃºltiplas classes e funÃ§Ãµes
- ClassificaÃ§Ã£o: **ALERTA** (faixa 401â€“500 indica disfunÃ§Ã£o estrutural)

**Impacto potencial:**
- God Module concentra 5 responsabilidades distintas (protocol, 3 backends, factory)
- ManutenÃ§Ã£o comprometida quando adicionar novos backends
- Testabilidade reduzida (testes monolÃ­ticos)
- **CRÃTICO:** Apesar de refatoraÃ§Ãµes terem criado novos arquivos modularizados (`domain/outbound_dedup.py`, `infra/outbound_dedup_memory.py`, etc.), o arquivo antigo **CONTINUA ATIVO E NÃƒO FOI REMOVIDO**, gerando **DUPLICAÃ‡ÃƒO CRÃTICA** no repositÃ³rio

**Status conforme Monitoramento_Regras-Padroes.md:**
- Monitoramento anterior nÃ£o registrou este arquivo
- REGRESSÃƒO: arquivo continua violando limite

**ObservaÃ§Ã£o crÃ­tica:**
O arquivo `.DEPRECATED` existe em `infra/outbound_dedupe.DEPRECATED`, mas o arquivo original `outbound_dedupe.py` continua no repositÃ³rio com suas 495 linhas intactas. Testes foram atualizados para usar novos mÃ³dulos, porÃ©m o arquivo monolÃ­tico nÃ£o foi removido ou desativado adequadamente.

---

### 2. adapters/whatsapp/normalizer.py

**Tamanho:** 287 linhas  
**Regra violada:** SeÃ§Ã£o 2.1 â€” Tamanho mÃ¡ximo 200 linhas (intervalo 201â€“400 = ATENÃ‡ÃƒO)  
**EvidÃªncia:**
- Arquivo contÃ©m ~15 funÃ§Ãµes de extraÃ§Ã£o pequenas (<40 linhas cada)
- Tamanho total: 287 linhas
- Estrutura: bem modularizada internamente, cada funÃ§Ã£o com responsabilidade clara
- Nenhuma funÃ§Ã£o ultrapassa 61 linhas

**Impacto potencial:** Baixo. Arquivo Ã© coeso (responsabilidade singular: "extrair dados de payloads WhatsApp"). FunÃ§Ãµes internas bem separadas e testÃ¡veis. Candidato a divisÃ£o apenas se crescimento ultrapassar 350 linhas.

**RecomendaÃ§Ã£o:** Monitorar; se crescer, considerar subpackage `adapters/whatsapp/normalizers/`.

---

### 3. infra/firestore_profiles.py

**Tamanho:** 243 linhas  
**Regra violada:** SeÃ§Ã£o 2.1 â€” Tamanho mÃ¡ximo 200 linhas (intervalo 201â€“400 = ATENÃ‡ÃƒO)  
**EvidÃªncia:**
- Arquivo contÃ©m: Protocol + dataclasses + 1 implementaÃ§Ã£o concreta (FirestoreUserProfileStore)
- Estrutura bem separada
- Nenhuma funÃ§Ã£o ultrapassa 50 linhas

**Impacto potencial:** Moderado. Concentra protocol + implementaÃ§Ã£o em um Ãºnico arquivo. Se houver novos backends (ex.: SQL), considerar separaÃ§Ã£o.

---

### 4. domain/whatsapp_message_types.py

**Tamanho:** 239 linhas  
**Regra violada:** SeÃ§Ã£o 2.1 â€” Tamanho mÃ¡ximo 200 linhas (intervalo 201â€“400 = ATENÃ‡ÃƒO)  
**EvidÃªncia:**
- Arquivo contÃ©m: ~23 classes Pydantic para tipos de mensagem WhatsApp
- Estrutura coesa (todos os tipos em uma definiÃ§Ã£o integrada)
- Nenhuma classe individual viola limites
- Linhas: 239, conforme anÃ¡lise anterior

**Impacto potencial:** Baixo. Arquivo Ã© coeso e bem estruturado. Conforme sistema cresce, pode justificar divisÃ£o em subdiretÃ³rio (ex.: `domain/message_types/text.py`, `domain/message_types/media.py`), porÃ©m nÃ£o Ã© urgente no nÃ­vel atual (239 < 300).

---

### 5. infra/secrets.py

**Tamanho:** 268 linhas  
**Regra violada:** SeÃ§Ã£o 2.1 â€” Tamanho mÃ¡ximo 200 linhas (intervalo 201â€“400 = ATENÃ‡ÃƒO)  
**EvidÃªncia:**
- Arquivo contÃ©m: Protocol + 2 implementaÃ§Ãµes (EnvSecretProvider ~40 linhas + SecretManagerProvider ~100 linhas)
- Estrutura bem separada
- Nenhuma funÃ§Ã£o ultrapassa 50 linhas

**Impacto potencial:** Baixo. Responsabilidade singular clara (provisioning de secrets). Dois providers estÃ£o bem isolados com comportamento previsÃ­vel.

---

### 6. infra/gcs_exporter.py

**Tamanho:** 328 linhas  
**Regra violada:** SeÃ§Ã£o 2.1 â€” Tamanho mÃ¡ximo 200 linhas (intervalo 201â€“400 = ATENÃ‡ÃƒO)  
**EvidÃªncia:**
- Arquivo contÃ©m: Protocol + dataclasses + 1 implementaÃ§Ã£o (GCSHistoryExporter)
- FunÃ§Ãµes: `save()`, `save_with_metadata()` (~56 linhas), `cleanup_old_exports()`, etc.
- 1 funÃ§Ã£o (`save_with_metadata()`) ultrapassa limite de 50 linhas (56 linhas)

**Impacto potencial:** Moderado-Alto. MÃ©todo `save_with_metadata()` com 56 linhas viola limite de 50 linhas (seÃ§Ã£o 2.1).

---

### 7. ai/orchestrator.py

**Tamanho:** 270 linhas  
**Regra violada:** SeÃ§Ã£o 2.1 â€” Tamanho mÃ¡ximo 200 linhas (intervalo 201â€“400 = ATENÃ‡ÃƒO)  
**EvidÃªncia:**
- Arquivo contÃ©m: AIOrchestrator + OutcomeDecider + helper functions
- Concentra lÃ³gica de orquestraÃ§Ã£o de IA com decisÃµes de outcomes
- Todas as funÃ§Ãµes <50 linhas

**Impacto potencial:** Moderado. Este Ã© um arquivo de orquestraÃ§Ã£o crÃ­tico. Conforme cresce (novos intents, novas estratÃ©gias de decisÃ£o), pode beneficiar-se de separaÃ§Ã£o em `application/orchestrators/` ou similar.

---

## ğŸš¨ Arquivos com ALERTA

### 1. infra/session_store.py

**Tamanho:** 417 linhas  
**Regra violada:** SeÃ§Ã£o 2.1 â€” Tamanho mÃ¡ximo 200 linhas (intervalo 401â€“500 = ALERTA) + SRP  
**EvidÃªncia:**
- Arquivo contÃ©m: Protocol + mÃºltiplas implementaÃ§Ãµes (Redis, Firestore, potencialmente Memory)
- Estrutura: concentra contrato + 2+ implementaÃ§Ãµes
- Linhas: 417 (confirmado)
- **Funcionalidade crÃ­tica:** PersistÃªncia de sessÃ£o (conforme Funcionamento.md Â§ 3.4)

**Impacto potencial:** ALTO. File size prÃ³ximo ao limite crÃ­tico (417 Ã© 208% do limite). Se adicionar terceira implementaÃ§Ã£o ou lÃ³gica de cleanup, ultrapassarÃ¡ 500 linhas facilmente.

**RecomendaÃ§Ã£o:** Separar protocol em `domain/session.py` e implementaÃ§Ãµes em `infra/session_store_redis.py`, `infra/session_store_firestore.py`, `infra/session_store_factory.py`.

---

### 2. infra/http.py

**Tamanho:** 376 linhas  
**Regra violada:** SeÃ§Ã£o 2.1 â€” Tamanho mÃ¡ximo 200 linhas (intervalo 201â€“400 = ALERTA)  
**EvidÃªncia:**
- Arquivo contÃ©m: HttpClientConfig + HttpError + HttpClient class + mÃºltiplos mÃ©todos de retry/backoff
- MÃ©todos bem isolados, nenhum ultrapassa 50 linhas
- Responsabilidade: Cliente HTTP centralizado com retry e timeout

**Impacto potencial:** Moderado. Arquivo Ã© bem estruturado internamente. Concentra retry/backoff logic que poderia ser extraÃ­da, porÃ©m Ã© coesa.

---

### 3. infra/dedupe.py

**Tamanho:** 352 linhas  
**Regra violada:** SeÃ§Ã£o 2.1 â€” Tamanho mÃ¡ximo 200 linhas (intervalo 201â€“400 = ALERTA) + funÃ§Ã£o `create_dedupe_store()` com ~52 linhas  
**EvidÃªncia:**
- Arquivo contÃ©m: Protocol + 2 implementaÃ§Ãµes (InMemoryDedupeStore, RedisDedupeStore)
- FunÃ§Ã£o `create_dedupe_store()`: ~52 linhas (limite: 50) â€” **VIOLAÃ‡ÃƒO LIMÃTROFE**
- Estrutura: bem separada internamente

**Impacto potencial:** Moderado-Alto. Factory function ultrapassa limite de 50 linhas.

**Status conforme Monitoramento_Regras-Padroes.md:** Arquivo estava reportado como refatorÃ¡vel, mas continua monolÃ­tico.

---

### 4. adapters/whatsapp/http_client.py

**Tamanho:** 243 linhas  
**Regra violada:** SeÃ§Ã£o 2.1 â€” Tamanho mÃ¡ximo 200 linhas (intervalo 201â€“400 = ALERTA) + mÃ©todo `send_message()` com 63 linhas  
**EvidÃªncia:**
- Arquivo contÃ©m: Protocol + 1 implementaÃ§Ã£o (WhatsAppHttpClient)
- MÃ©todo `send_message()`: 63 linhas (limite: 50) â€” **VIOLAÃ‡ÃƒO CLARA**
- Responsabilidade: Envio de mensagens via Graph API

**Impacto potencial:** Alto. MÃ©todo crÃ­tico (`send_message()`) ultrapassa significativamente o limite (63 vs 50 linhas).

---

### 5. adapters/whatsapp/template_manager.py

**Tamanho:** 329 linhas  
**Regra violada:** SeÃ§Ã£o 2.1 â€” Tamanho mÃ¡ximo 200 linhas (intervalo 201â€“400 = ALERTA)  
**EvidÃªncia:**
- Arquivo contÃ©m: Protocol + TemplateCache + TemplateManager class
- MÃ©todos bem separados, nenhum ultrapassa 50 linhas
- Responsabilidade: Gerenciamento de templates com cache e sync

**Impacto potencial:** Moderado. Arquivo Ã© funcionalmente coeso, porÃ©m prÃ³ximo ao limite crÃ­tico.

---

### 6. infra/firestore_audit.py

**Tamanho:** 215 linhas  
**Regra violada:** SeÃ§Ã£o 2.1 â€” Tamanho mÃ¡ximo 200 linhas (intervalo 201â€“400 = ATENÃ‡ÃƒO elevado) + mÃ©todo `append_event()` com 67 linhas  
**EvidÃªncia:**
- Arquivo contÃ©m: Protocol + implementaÃ§Ã£o concreta (FirestoreAuditLogStore)
- MÃ©todo `append_event()`: 67 linhas (limite: 50) â€” **VIOLAÃ‡ÃƒO CLARA**
- MÃ©todo concentra lÃ³gica de hash encadeado com validaÃ§Ã£o de causalidade

**Impacto potencial:** Alto. MÃ©todo crÃ­tico de auditoria viola significativamente (67 vs 50 linhas).

---

### 7. application/pipeline.py

**Tamanho:** 326 linhas  
**Regra violada:** SeÃ§Ã£o 2.1 â€” Tamanho mÃ¡ximo 200 linhas (intervalo 201â€“400 = ALERTA) + mÃ©todo `process_webhook()` com **176 linhas**  
**EvidÃªncia:**
- Arquivo contÃ©m: ProcessedMessage + PipelineResult + WhatsAppInboundPipeline class
- MÃ©todo `process_webhook()`: **176 linhas** (limite: 50) â€” **VIOLAÃ‡ÃƒO CRÃTICA**
- Responsabilidade: Pipeline completo de processamento inbound (validaÃ§Ã£o, dedupe, abuse check, orchestration, persistÃªncia)
- Este mÃ©todo implementa lÃ³gica de: Funcionamento.md Â§ 3.1â€“3.4 (outcomes, sessÃ£o, multi-intent)

**Impacto potencial:** CRÃTICO. 
- MÃ©todo Ã© 3.5x maior que o limite permitido
- Concentra mÃºltiplas responsabilidades: dedup, abuse detection, orchestration, session persistence
- Testabilidade severamente comprometida
- Manutenibilidade crÃ­tica (compreender fluxo exige ler 176 linhas de una vez)

**RecomendaÃ§Ã£o urgente:** Extrair sub-mÃ©todos: `_dedupe_and_check_abuse()`, `_orchestrate_ai()`, `_persist_session()`, `_prepare_response()`.

---

### 8. application/export.py â€” FUNÃ‡ÃƒO `execute()`

**Tamanho arquivo:** 177 linhas (OK)  
**Regra violada:** SeÃ§Ã£o 2.1 â€” FunÃ§Ã£o `execute()` com **73 linhas** (limite: 50)  
**EvidÃªncia:**
- Arquivo foi refatorado de 410 â†’ 177 linhas âœ…
- PorÃ©m, mÃ©todo `execute()` ainda tem 73 linhas (limite: 50) â€” **VIOLAÃ‡ÃƒO**
- Apesar de ter sido refatorado em relaÃ§Ã£o Ã  auditoria anterior, esta funÃ§Ã£o ainda Ã© demasiado longa

**Impacto potencial:** Moderado-Alto. MÃ©todo de orquestraÃ§Ã£o crÃ­tico Ã© 46% maior que o limite.

---

### 9. infra/outbound_dedup_firestore.py â€” FUNÃ‡ÃƒO `check_and_mark()`

**Tamanho arquivo:** 161 linhas (OK)  
**Regra violada:** SeÃ§Ã£o 2.1 â€” FunÃ§Ã£o `check_and_mark()` com 63 linhas (limite: 50)  
**EvidÃªncia:**
- MÃ©todo implementa transaÃ§Ã£o Firestore com validaÃ§Ã£o de expiraÃ§Ã£o
- 63 linhas (limite: 50) â€” **VIOLAÃ‡ÃƒO**
- Arquivo Ã© novo (refatoraÃ§Ã£o de outbound_dedupe.py)

**Impacto potencial:** Moderado. FunÃ§Ã£o crÃ­tica de deduplicaÃ§Ã£o, porÃ©m refactorÃ¡vel.

---

## âŒ Arquivos com VIOLAÃ‡ÃƒO CRÃTICA

### 1. infra/outbound_dedupe.py â€” DUPLICAÃ‡ÃƒO CRÃTICA

**Tamanho:** 495 linhas  
**Regra violada:**
- SeÃ§Ã£o 2.1: Tamanho mÃ¡ximo 200 linhas (495 linhas = 247% do limite)
- SRP: Concentra Protocol + 3 implementaÃ§Ãµes + 2 funÃ§Ãµes helper + factory (5 responsabilidades distintas)
- **DUPLICAÃ‡ÃƒO CRÃTICA:** Apesar de refatoraÃ§Ãµes terem criado novos arquivos modularizados (`domain/outbound_dedup.py`, `infra/outbound_dedup_*.py`), o arquivo original **CONTINUA ATIVO NO REPOSITÃ“RIO** com sua estrutura monolÃ­tica intacta

**EvidÃªncia:**
- Arquivo: `/home/fortes/RepositÃ³rios/pyloto_corp/src/pyloto_corp/infra/outbound_dedupe.py`
- Linhas: 495 (confirmado via anÃ¡lise de cÃ³digo)
- Imports: Arquivo nÃ£o estÃ¡ sendo importado pelo cÃ³digo principal (testes usam novos mÃ³dulos)
- Arquivo `.DEPRECATED`: existe em `/infra/outbound_dedupe.DEPRECATED` mas o arquivo original continua intacto
- **Impacto:** DuplicaÃ§Ã£o crÃ­tica causa confusÃ£o, manutenÃ§Ã£o duplicada, risco de regressÃ£o se desenvolvedor modificar arquivo errado

**Status conforme Monitoramento_Regras-Padroes.md:**
- RefatoraÃ§Ãµes foram iniciadas (6 novos arquivos criados)
- PorÃ©m arquivo antigo **NÃƒO foi removido** â€” permanece ativo com 495 linhas intactas
- ClassificaÃ§Ã£o: **VIOLAÃ‡ÃƒO CRÃTICA** por duplicaÃ§Ã£o de cÃ³digo

**Risco:** CRÃTICO
- ConfusÃ£o entre mÃ³dulos antigos vs novos durante manutenÃ§Ã£o
- Possibilidade de imports acidentais do arquivo antigo
- DÃ©bito tÃ©cnico acumulado

---

## ğŸ§­ DivergÃªncias com Funcionamento.md (Contrato de Produto)

### 1. Conformidade com Outcomes CanÃ´nicos

**Regra (Funcionamento.md Â§ 3.1):** "Toda sessÃ£o deve encerrar com exatamente um outcome terminal."

**VerificaÃ§Ã£o:**
- âœ… CÃ³digo implementa 8 outcomes: HANDOFF_HUMAN, SELF_SERVE_INFO, ROUTE_EXTERNAL, SCHEDULED_FOLLOWUP, AWAITING_USER, DUPLICATE_OR_SPAM, UNSUPPORTED, FAILED_INTERNAL
- âœ… Enum `Outcome` em `domain/enums.py` com todos os estados
- âœ… Classe `OutcomeDecider` em `ai/orchestrator.py` implementa decisÃ£o de outcome
- âš ï¸ **PORÃ‰M:** Pipeline.py `process_webhook()` tem 176 linhas e nÃ£o estÃ¡ claro se **toda** execuÃ§Ã£o garante outcome terminal (testabilidade comprometida pela tamanho do mÃ©todo)

**DivergÃªncia:** MODERADA
- Contrato estÃ¡ implementado, mas testabilidade e auditabilidade comprometidas pelo tamanho da funÃ§Ã£o principal
- Requer anÃ¡lise manual de 176 linhas para confirmar invariante

---

### 2. Conformidade com Multi-Intent (mÃ¡x. 3)

**Regra (Funcionamento.md Â§ 3.2):** "MÃ¡ximo 3 intenÃ§Ãµes por sessÃ£o; apenas uma ativa."

**VerificaÃ§Ã£o:**
- âœ… Classe `IntentQueue` em `domain/intent_queue.py` implementa fila com limite configurÃ¡vel (padrÃ£o: 3)
- âœ… `SessionState` mantÃ©m `active_intent` (uma intenÃ§Ã£o ativa)
- âœ… Pipeline valida limite antes de adicionar nova intenÃ§Ã£o
- âš ï¸ **PORÃ‰M:** LÃ³gica de enforcement estÃ¡ espalhada em `process_webhook()` (176 linhas), dificultando auditoria

**DivergÃªncia:** BAIXA
- Contrato implementado corretamente
- Enforcement estÃ¡ funcional, apesar de testabilidade comprometida

---

### 3. Conformidade com ContenÃ§Ã£o de Contexto (Anti-Token-Bloat)

**Regra (Funcionamento.md Â§ 3.3):** "IntenÃ§Ãµes nÃ£o ativas armazenam apenas: intent_type, timestamp, confidence."

**VerificaÃ§Ã£o:**
- âœ… `IntentItem` em `domain/intent_queue.py` define apenas esses 3 campos para intenÃ§Ãµes nÃ£o ativas
- âœ… Contexto detalhado existe apenas para `active_intent`
- âœ… SessionState implementa corretamente isolamento

**DivergÃªncia:** NENHUMA âœ…
- Contrato perfeitamente implementado

---

### 4. Conformidade com Escopo "Front Door"

**Regra (Funcionamento.md Â§ 1):** "pyloto_corp nÃ£o executa operaÃ§Ã£o final, nÃ£o fecha contratos, nÃ£o gerencia pedidos operacionais."

**VerificaÃ§Ã£o:**
- âœ… CÃ³digo nÃ£o contÃ©m lÃ³gica de fechamento de contrato
- âœ… CÃ³digo nÃ£o contÃ©m persistÃªncia de pedidos operacionais
- âœ… Orquestrador apenas coleta dados iniciais e realiza handoff
- âœ… `HandoffProcessor` em `application/handoff.py` valida que informaÃ§Ãµes sÃ£o apenas iniciais

**DivergÃªncia:** NENHUMA âœ…
- Escopo estÃ¡ respeitado

---

### 5. Conformidade com Timeout e ROUTE_EXTERNAL

**Regra (Funcionamento.md Â§ 3.1):** "ROUTE_EXTERNAL encerra sessÃ£o e impÃµe timeout de 30 minutos para novo contato."

**VerificaÃ§Ã£o:**
- âœ… `Outcome.ROUTE_EXTERNAL` existe
- âš ï¸ **PENDENTE:** NÃ£o foi possÃ­vel verificar implementaÃ§Ã£o de timeout de 30 minutos no cÃ³digo (requer anÃ¡lise detalhada de SessionStore)
- SessionStore tem TTL configurÃ¡vel, mas timeout especÃ­fico para ROUTE_EXTERNAL nÃ£o estÃ¡ documentado

**DivergÃªncia:** MODERADA
- Outcome existe, mas validar timeout de 30 minutos requer anÃ¡lise mais profunda do SessionStore
- ImplementaÃ§Ã£o pode estar correta, porÃ©m nÃ£o estÃ¡ documentada de forma clara

---

## ğŸ“‰ RegressÃµes vs Monitoramento_Regras-Padroes.md

### Status Anterior (conforme Monitoramento_Regras-Padroes.md atualizado em 25/01/2026 18:45)

O documento de monitoramento registra mÃºltiplas tarefas concluÃ­das nas Ãºltimas horas:
- âœ… MediaUploader refatorado (260 â†’ 188 linhas)
- âœ… TemplateManager implementado (250 linhas)
- âœ… UserProfileStore expandido (110 + 243 linhas)
- âœ… Export.py refatorado (410 â†’ 177 linhas refactorizado)
- âœ… Firestore stores implementados

### Status Atual (25/01/2026 20:00)

**REGRESSÃƒO CRÃTICA IDENTIFICADA:**

| Arquivo | Status Anterior | Status Atual | ClassificaÃ§Ã£o |
|---------|---|---|---|
| outbound_dedupe.py | RefatoraÃ§Ã£o iniciada (novos arquivos criados) | **ATIVA COM 495 LINHAS** | âŒ REGRESSÃƒO CRÃTICA |
| export.py | 410 linhas (ALERTA) | **177 linhas** âœ… | âœ… MELHORIA |
| session_store.py | NÃ£o monitorado | **417 linhas (ALERTA)** | âš ï¸ NOVO PROBLEMA |
| http.py | NÃ£o monitorado | **376 linhas (ALERTA)** | âš ï¸ NOVO PROBLEMA |
| pipeline.py | NÃ£o monitorado | **326 linhas + mÃ©todo 176 linhas** | âŒ CRÃTICO |

### AnÃ¡lise de RegressÃ£o

1. **outbound_dedupe.py (CRÃTICO):**
   - Arquivo antigo continua com 495 linhas intactas
   - Novos mÃ³dulos refatorados existem (`domain/outbound_dedup.py`, `infra/outbound_dedup_*.py`)
   - **PROBLEMA:** CoexistÃªncia de dois sistemas causa duplicaÃ§Ã£o crÃ­tica
   - **RISCO:** Desenvolvedor pode importar arquivo errado, reintroduzindo problemas jÃ¡ corrigidos

2. **export.py (âœ… RESOLUÃ‡ÃƒO):**
   - Confirmado como refatorado de 410 â†’ 177 linhas
   - DependÃªncia injetada corretamente via `SecretProvider`
   - âœ… Sem regressÃ£o, melhoria clara

3. **pipeline.py (âŒ REGRESSÃƒO ARQUITETURAL):**
   - MÃ©todo `process_webhook()` com 176 linhas Ã© 3.5x o limite
   - Implementa lÃ³gica de Funcionamento.md Â§ 3.1â€“3.4 (outcomes, sessÃ£o, multi-intent) em uma Ãºnica funÃ§Ã£o mega
   - Testabilidade comprometida, compreensÃ£o dificultada
   - **Este Ã© um novo problema nÃ£o monitorado anteriormente**

---

## ğŸ“Š Resumo Executivo

### EstatÃ­sticas Gerais

| MÃ©trica | Valor |
|---------|-------|
| **Arquivos analisados** | 95 |
| **Em conformidade** | 51 âœ… |
| **Com ATENÃ‡ÃƒO** | 7 âš ï¸ |
| **Com ALERTA** | 9 ğŸš¨ |
| **Com VIOLAÃ‡ÃƒO CRÃTICA** | 1 âŒ |
| **Total de violaÃ§Ãµes** | 17 |
| **Conformidade geral** | **54%** |

### ViolaÃ§Ãµes por Categoria

| Categoria | Quantidade | Severidade |
|-----------|-----------|-----------|
| Tamanho de arquivo (>200 linhas) | 15 | ATENÃ‡ÃƒO-CRÃTICA |
| Tamanho de funÃ§Ã£o (>50 linhas) | 10 | ALERTA-CRÃTICA |
| SRP / God Module | 3 | ALERTA-CRÃTICA |
| DuplicaÃ§Ã£o de cÃ³digo | 1 | CRÃTICA |
| **Total** | **29** | **ALTO** |

### Ãreas mais Afetadas

1. **Infra (7 violaÃ§Ãµes)**
   - outbound_dedupe.py (495 linhas, CRÃTICO + duplicaÃ§Ã£o)
   - session_store.py (417 linhas, ALERTA)
   - http.py (376 linhas, ALERTA)
   - dedupe.py (352 linhas, ALERTA + funÃ§Ã£o 52 linhas)
   - gcs_exporter.py (328 linhas, ALERTA + funÃ§Ã£o 56 linhas)
   - secrets.py (268 linhas, ATENÃ‡ÃƒO)
   - firestore_audit.py (215 linhas, ALERTA + funÃ§Ã£o 67 linhas)

2. **Application (3 violaÃ§Ãµes)**
   - pipeline.py (326 linhas, ALERTA + funÃ§Ã£o 176 linhas) â€” **CRÃTICO**
   - export.py (177 linhas OK, porÃ©m funÃ§Ã£o 73 linhas) â€” ALERTA
   - conversations.py (176 linhas OK)

3. **Adapters (4 violaÃ§Ãµes)**
   - normalizer.py (287 linhas, ATENÃ‡ÃƒO)
   - template_manager.py (329 linhas, ALERTA)
   - http_client.py (243 linhas, ALERTA + funÃ§Ã£o 63 linhas)
   - media_uploader.py (188 linhas, OK apÃ³s refactor)

4. **Domain (1 violaÃ§Ã£o)**
   - whatsapp_message_types.py (239 linhas, ATENÃ‡ÃƒO)

### Problemas CrÃ­ticos Identificados

1. **DuplicaÃ§Ã£o CrÃ­tica â€” outbound_dedupe.py**
   - Arquivo antigo (495 linhas) coexiste com refatoraÃ§Ãµes novos mÃ³dulos
   - Nunca foi removido ou desativado
   - Risco de confusÃ£o, manutenÃ§Ã£o duplicada, possÃ­vel regressÃ£o
   - **AÃ‡ÃƒO IMEDIATA REQUERIDA:** Remover arquivo antigo ou consolidar em um Ãºnico sistema

2. **Mega-FunÃ§Ã£o â€” pipeline.py::process_webhook()**
   - 176 linhas de lÃ³gica intra-funÃ§Ã£o (3.5x limite)
   - Implementa mÃºltiplas responsabilidades: dedupe, abuse check, orchestration, persistence
   - Testabilidade severamente comprometida
   - **AÃ‡ÃƒO URGENTE:** Extrair em sub-mÃ©todos

3. **FunÃ§Ãµes CrÃ­ticas Acima do Limite**
   - FirestoreAuditLogStore.append_event() â€” 67 linhas (34% acima)
   - WhatsAppHttpClient.send_message() â€” 63 linhas (26% acima)
   - FirestoreOutboundDedupeStore.check_and_mark() â€” 63 linhas (26% acima)
   - GCSHistoryExporter.save_with_metadata() â€” 56 linhas (12% acima)
   - ExportConversationUseCase.execute() â€” 73 linhas (46% acima)

### Conformidade Funcional (Funcionamento.md)

| Aspecto | Status | Notas |
|---------|--------|-------|
| Outcomes canÃ´nicos (8 tipos) | âœ… Implementado | Testabilidade comprometida por pipeline.py |
| Multi-intent (mÃ¡x. 3) | âœ… Implementado | ValidaÃ§Ã£o funcional, enforcement integrado |
| ContenÃ§Ã£o de contexto | âœ… Implementado | Anti-token-bloat funcionando corretamente |
| Escopo "front door" | âœ… Implementado | Sem operaÃ§Ãµes finais ou closure de contrato |
| Timeout ROUTE_EXTERNAL | âš ï¸ Pendente | ImplementaÃ§Ã£o pode estar correta, nÃ£o verificada |

### Testes e Cobertura

| MÃ©trica | Valor |
|---------|-------|
| **Arquivos de teste** | 30 |
| **FunÃ§Ãµes de teste** | 378+ |
| **Cobertura estimada** | >90% (conforme Monitoramento) |
| **Estrutura de testes** | âœ… Bem organizada (unit, integration, E2E) |

---

## ğŸ“‹ RecomendaÃ§Ãµes Imediatas (Prioridade)

### ğŸ”´ CRÃTICO (Bloqueia Deploy)

1. **Remover ou consolidar arquivo antigo `infra/outbound_dedupe.py`**
   - OpÃ§Ã£o A: Remover arquivo completamente (recomendado)
   - OpÃ§Ã£o B: Converter em re-export dos novos mÃ³dulos com deprecaÃ§Ã£o explÃ­cita
   - Verificar que nenhum cÃ³digo importa diretamente deste arquivo

2. **Refatorar `application/pipeline.py::process_webhook()` (176 linhas â†’ ~50 linhas)**
   - Extrair: `_dedupe_and_check_abuse()` (~40 linhas)
   - Extrair: `_orchestrate_decision()` (~40 linhas)
   - Extrair: `_persist_session()` (~30 linhas)
   - Extrair: `_prepare_response()` (~20 linhas)

### ğŸŸ  ALTO (Deve ser resolvido antes de produÃ§Ã£o)

3. **Refatorar `infra/session_store.py` (417 linhas â†’ 2-3 arquivos)**
   - Separar protocol em `domain/session.py`
   - Criar `infra/session_store_redis.py` e `infra/session_store_firestore.py`
   - Criar `infra/session_store_factory.py`

4. **Reduzir funÃ§Ãµes crÃ­ticas acima do limite (>50 linhas):**
   - `FirestoreAuditLogStore.append_event()` (67 â†’ 45 linhas)
   - `WhatsAppHttpClient.send_message()` (63 â†’ 45 linhas)
   - `ExportConversationUseCase.execute()` (73 â†’ 45 linhas)
   - `FirestoreOutboundDedupeStore.check_and_mark()` (63 â†’ 45 linhas)

### ğŸŸ¡ MÃ‰DIO (PrÃ³ximas sprints)

5. **Monitorar crescimento de arquivos ATENÃ‡ÃƒO (201â€“400 linhas):**
   - adapters/whatsapp/normalizer.py (287 linhas) â€” Acompanhar
   - infra/gcs_exporter.py (328 linhas) â€” Acompanhar
   - infra/secrets.py (268 linhas) â€” Acompanhar
   - ai/orchestrator.py (270 linhas) â€” Acompanhar

6. **Melhorar teste e validaÃ§Ã£o de timeout ROUTE_EXTERNAL (30 minutos)**
   - Confirmar implementaÃ§Ã£o em SessionStore
   - Adicionar testes explÃ­citos

---

## âœ… ConclusÃ£o

O repositÃ³rio `pyloto_corp` apresenta **54% de conformidade** com `regras_e_padroes.md`. Apesar de mÃºltiplas refatoraÃ§Ãµes terem sido executadas (export.py, media_uploader.py, etc.), **uma violaÃ§Ã£o crÃ­tica permanece nÃ£o resolvida: a duplicaÃ§Ã£o de cÃ³digo em `infra/outbound_dedupe.py`** (495 linhas), que coexiste com refatoraÃ§Ãµes novas.

**AlÃ©m disso, uma nova regressÃ£o arquitetural foi identificada:** a funÃ§Ã£o `process_webhook()` em `pipeline.py` com 176 linhas viola severamente os limites e testabilidade.

**Status de Deploy:** â›” **BLOQUEADO** por violaÃ§Ãµes crÃ­ticas atÃ© que:
1. Arquivo antigo `outbound_dedupe.py` seja removido/consolidado
2. FunÃ§Ã£o `process_webhook()` seja refatorada

Outros **9 arquivos com ALERTA** e **7 com ATENÃ‡ÃƒO** devem ser endereÃ§ados antes de produÃ§Ã£o para manter conformidade com padrÃµes de manutenibilidade e testabilidade.
